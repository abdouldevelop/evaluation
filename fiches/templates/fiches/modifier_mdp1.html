{% extends 'fiches/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5 max-w-lg mx-auto p-4 sm:p-6 bg-white shadow-lg rounded-lg">
    <h2 class="text-center text-2xl font-bold mb-6 text-gray-800">üîê Modifier votre mot de passe</h2>

    <!-- Alerte premi√®re connexion -->
    {% if first_change %}
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-lg">
        <div class="flex items-start">
            <svg class="w-6 h-6 text-yellow-400 mr-3 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
            <div class="flex-1">
                <h3 class="text-yellow-800 font-semibold mb-1">üîí Premi√®re connexion</h3>
                <p class="text-yellow-700 text-sm">
                    Vous utilisez actuellement le mot de passe par d√©faut (<strong>0000</strong>).
                    Pour des raisons de s√©curit√©, vous devez le modifier avant d'acc√©der au syst√®me.
                </p>
                <p class="text-yellow-700 text-sm mt-2">
                    <strong>Note :</strong> Dans le champ "Ancien mot de passe", entrez <code class="bg-yellow-100 px-2 py-1 rounded">0000</code>
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} flex items-center p-4 mb-4 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}" role="alert">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    {% if message.tags == 'error' %}
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    {% else %}
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    {% endif %}
                </svg>
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" id="passwordForm" onsubmit="return validateForm()">
        {% csrf_token %}

        <div class="mb-4">
            <label for="ancien_mdp" class="form-label block text-sm font-medium text-gray-700">Ancien mot de passe :</label>
            <div class="relative">
                <input type="password" class="form-control w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="ancien_mdp" name="ancien_mdp" required aria-describedby="ancien_mdp_help">
                <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm" onclick="togglePassword('ancien_mdp', this)">
                    <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zm6.293-3.293a1 1 0 011.414 1.414C19.582 13.247 16.366 16 12 16c-4.366 0-7.582-2.753-10.707-5.879a1 1 0 011.414-1.414C5.418 11.247 8.634 14 12 14c3.366 0 6.582-2.753 9.293-5.293z"/></svg>
                </button>
            </div>
            <small id="ancien_mdp_help" class="text-gray-500 text-xs">Entrez votre mot de passe actuel.</small>
        </div>

        <div class="mb-4">
            <label for="nouveau_mdp" class="form-label block text-sm font-medium text-gray-700">Nouveau mot de passe :</label>
            <div class="relative">
                <input type="password" class="form-control w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="nouveau_mdp" name="nouveau_mdp" required aria-describedby="nouveau_mdp_help">
                <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm" onclick="togglePassword('nouveau_mdp', this)">
                    <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zm6.293-3.293a1 1 0 011.414 1.414C19.582 13.247 16.366 16 12 16c-4.366 0-7.582-2.753-10.707-5.879a1 1 0 011.414-1.414C5.418 11.247 8.634 14 12 14c3.366 0 6.582-2.753 9.293-5.293z"/></svg>
                </button>
            </div>
            <small id="nouveau_mdp_help" class="text-gray-500 text-xs">Doit contenir au moins 8 caract√®res.</small>
        </div>

        <div class="mb-4">
            <label for="confirmation_mdp" class="form-label block text-sm font-medium text-gray-700">Confirmer le nouveau mot de passe :</label>
            <div class="relative">
                <input type="password" class="form-control w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="confirmation_mdp" name="confirmation_mdp" required aria-describedby="confirmation_mdp_help">
                <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm" onclick="togglePassword('confirmation_mdp', this)">
                    <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zm6.293-3.293a1 1 0 011.414 1.414C19.582 13.247 16.366 16 12 16c-4.366 0-7.582-2.753-10.707-5.879a1 1 0 011.414-1.414C5.418 11.247 8.634 14 12 14c3.366 0 6.582-2.753 9.293-5.293z"/></svg>
                </button>
            </div>
            <small id="confirmation_mdp_help" class="text-gray-500 text-xs">R√©p√©tez le nouveau mot de passe.</small>
            <p id="passwordMismatch" class="text-red-600 text-sm mt-1 hidden">Les mots de passe ne correspondent pas.</p>
        </div>
        <div class="flex space-x-4">
            {% if not first_change %}
            <button type="button" onclick="history.back()" class="w-1/2 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200">
                Retour
            </button>
            {% endif %}
            <button type="submit" class="{% if first_change %}w-full{% else %}w-full{% endif %} px-4 py-2 bg-green-900 text-white rounded-lg shadow-md hover:bg-orange-600 text-sm transition-colors duration-150">
                {% if first_change %}
                    üîê Cr√©er mon nouveau mot de passe
                {% else %}
                    Modifier le mot de passe
                {% endif %}
            </button>
        </div>
    </form>
</div>

<script>
function togglePassword(inputId, button) {
    const input = document.getElementById(inputId);
    const isPassword = input.type === 'password';
    input.type = isPassword ? 'text' : 'password';
    button.innerHTML = isPassword
        ? `<svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.366 0-7.582-2.753-10.707-5.879a1 1 0 011.414-1.414C5.418 14.247 8.634 17 12 17c1.585 0 3.073-.584 4.293-1.707M9 12a3 3 0 006 0 3 3 0 00-6 0zm12.293-3.293a1 1 0 011.414 1.414C19.582 13.247 16.366 16 12 16c-1.585 0-3.073-.584-4.293-1.707"/></svg>`
        : `<svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zm6.293-3.293a1 1 0 011.414 1.414C19.582 13.247 16.366 16 12 16c-4.366 0-7.582-2.753-10.707-5.879a1 1 0 011.414-1.414C5.418 11.247 8.634 14 12 14c3.366 0 6.582-2.753 9.293-5.293z"/></svg>`;
}

function validateForm() {
    const newPassword = document.getElementById('nouveau_mdp').value;
    const confirmPassword = document.getElementById('confirmation_mdp').value;
    const mismatchMessage = document.getElementById('passwordMismatch');

    if (newPassword !== confirmPassword) {
        mismatchMessage.classList.remove('hidden');
        return false;
    }
    mismatchMessage.classList.add('hidden');
    return true;
}
</script>
{% endblock %}